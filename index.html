<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Amour √† travers le monde ‚Äî Jeu simple</title>
  <style>
    :root {
      --bg: #0f172a;            /* slate-900 */
      --panel: #111827;         /* gray-900 */
      --muted: #94a3b8;         /* slate-400 */
      --ink: #e5e7eb;           /* gray-200 */
      --accent: #f472b6;        /* pink-400 */
      --accent-2: #38bdf8;      /* sky-400 */
      --good: #34d399;          /* emerald-400 */
      --warn: #fbbf24;          /* amber-400 */
      --bad: #fb7185;           /* rose-400 */
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }

    body {
      margin: 0;
      background: radial-gradient(1000px 600px at 70% -10%, #1f2937 0%, var(--bg) 60%);
      color: var(--ink);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Ubuntu, Cantarell, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    .wrap {
      max-width: 980px;
      margin: 24px auto;
      padding: 0 16px 48px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 16px;
    }

    header h1 {
      font-size: 22px;
      font-weight: 700;
      letter-spacing: 0.2px;
      margin: 0;
    }

    header .hint { color: var(--muted); font-size: 13px; }

    .panel {
      background: linear-gradient(180deg, #0b1220 0%, #0d1220 100%);
      border: 1px solid rgba(148,163,184,0.15);
      border-radius: 14px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.03);
      padding: 14px;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    @media (min-width: 880px) {
      .grid {
        grid-template-columns: 1.1fr 1fr;
      }
    }

    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }

    .field { display: flex; flex-direction: column; gap: 6px; }
    label { font-size: 12px; color: var(--muted); }

    input[type="text"], select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(148,163,184,0.18);
      background: #0b1220;
      color: var(--ink);
      outline: none;
      transition: border-color 0.15s ease;
      font-size: 14px;
    }

    input[type="text"]:focus, select:focus { border-color: var(--accent-2); }

    .controls { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }

    button {
      appearance: none;
      border: none;
      background: linear-gradient(180deg, #1f2937 0%, #111827 100%);
      color: var(--ink);
      border: 1px solid rgba(148,163,184,0.18);
      padding: 10px 14px;
      border-radius: 10px;
      font-weight: 600;
      letter-spacing: 0.2px;
      cursor: pointer;
      transition: transform 0.06s ease, border-color 0.15s ease;
    }

    button:hover { border-color: var(--accent-2); }
    button:active { transform: translateY(1px); }

    .btn-accent { border-color: rgba(244,114,182,0.45); background: linear-gradient(180deg, #312e81 0%, #111827 100%); }

    .note { font-size: 13px; color: var(--muted); }

    .canvas-wrap {
      position: relative;
      width: 100%;
      aspect-ratio: 2 / 1; /* world aspect */
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid rgba(148,163,184,0.18);
      background: linear-gradient(180deg, #0b1220 0%, #0a1020 100%);
    }

    canvas { width: 100%; height: 100%; display: block; }

    .score-line {
      margin-top: 10px;
      font-size: 14px;
    }

    .score-line strong { color: var(--good); }

    .out {
      padding: 12px;
      border-radius: 10px;
      border: 1px solid rgba(148,163,184,0.18);
      background: #0b1220;
      min-height: 64px;
      white-space: pre-wrap;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.18);
      background: #0b1220;
      color: var(--muted);
      font-size: 12px;
    }

    .switch {
      display: inline-flex; align-items: center; gap: 8px; cursor: pointer; user-select: none; color: var(--muted);
    }
    .switch input { width: 18px; height: 18px; }

    .legend { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; color: var(--muted); font-size: 12px; margin-top: 8px; }
    .legend .key { display: inline-flex; align-items: center; gap: 6px; }
    .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
    .dot.homme { background: var(--accent-2); box-shadow: 0 0 0 2px rgba(56,189,248,0.25); }
    .dot.femme { background: var(--accent); box-shadow: 0 0 0 2px rgba(244,114,182,0.25); }

    .xp { margin-top: 10px; display: flex; flex-direction: column; gap: 6px; }
    .xp-row { display:flex; gap:8px; align-items:center; flex-wrap: wrap; }
    .xp-bar { width: 100%; height: 10px; background: #0b1220; border: 1px solid rgba(148,163,184,0.18); border-radius: 999px; overflow: hidden; }
    .xp-fill { height: 100%; background: linear-gradient(90deg, #38bdf8, #f472b6); width: 0%; transition: width 0.3s ease; }

    .profile-upload { display:flex; align-items:center; gap:10px; }
    .avatar-preview { width: 44px; height: 44px; border-radius: 50%; border:1px solid rgba(148,163,184,0.18); object-fit: cover; background: #0b1220; }
    .emoji-picker { display: flex; flex-wrap: wrap; gap: 6px; }
    .emoji-btn { padding: 6px 8px; border-radius: 8px; border: 1px solid rgba(148,163,184,0.18); background: #0b1220; cursor: pointer; font-size: 20px; }
    .emoji-btn.selected { border-color: var(--accent-2); box-shadow: 0 0 0 2px rgba(56,189,248,0.2) inset; }

    .out [dir="rtl"] { direction: rtl; text-align: right; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Amour √† travers le monde üåçüíò</h1>
      <div class="hint">Fichier unique, fonctionne hors-ligne. iPad friendly.</div>
    </header>

    <div class="grid">
      <section class="panel">
        <div class="row">
          <div class="field">
            <label>Nom (homme)</label>
            <input id="nameH" type="text" placeholder="Adam" value="Adam" />
          </div>
          <div class="field">
            <label>Pays (homme)</label>
            <select id="countryH"></select>
          </div>
        </div>
        <div class="row">
          <div class="field">
            <label>Nom (femme)</label>
            <input id="nameF" type="text" placeholder="Eva" value="Eva" />
          </div>
          <div class="field">
            <label>Pays (femme)</label>
            <select id="countryF"></select>
          </div>
        </div>

        <div class="controls" style="margin-top: 6px;">
          <div class="field" style="min-width:220px;">
            <label for="langSelect">Langue du message</label>
            <select id="langSelect" aria-label="Choisir la langue">
              <option value="fr">Fran√ßais</option>
              <option value="darija_lat">Darija (latin)</option>
              <option value="darija_ar">Darija (ÿßŸÑÿπÿ±ÿ®Ÿäÿ©)</option>
              <option value="all">Tous</option>
            </select>
          </div>
          <label class="switch"><input id="darija" type="checkbox" aria-label="Inclure darija (legacy)"/> Inclure une version en darija</label>
          <span class="pill">Conseil: tu peux zoomer avec deux doigts sur iPad</span>
        </div>

        <div class="xp" aria-live="polite">
          <div class="xp-row">
            <span class="pill" id="xpLabel">XP: 0</span>
            <button id="btnResetXP" aria-describedby="xpLabel">R√©initialiser XP</button>
          </div>
          <div class="xp-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" aria-label="Progression XP">
            <div class="xp-fill" id="xpFill"></div>
          </div>
        </div>

        <div class="row" style="margin-top:8px;">
          <div class="field">
            <label>Photo de profil</label>
            <div class="profile-upload">
              <img id="avatarPreview" class="avatar-preview" alt="Aper√ßu photo" />
              <input id="avatarInput" type="file" accept="image/*" aria-label="T√©l√©charger une photo" />
            </div>
          </div>
          <div class="field">
            <label>Emoji pr√©f√©r√©</label>
            <div id="emojiPicker" class="emoji-picker" role="listbox" aria-label="Choisir un emoji"></div>
          </div>
        </div>

        <div class="controls" style="margin-top: 12px;">
          <button id="btnUpdate" class="btn-accent">Mettre √† jour la carte</button>
          <button id="btnMsg">G√©n√©rer un message mignon üíå</button>
          <button id="btnCopy">Copier le message</button>
          <button id="btnDownload">T√©l√©charger l'image</button>
        </div>

        <div id="scoreLine" class="score-line"></div>
      </section>

      <section class="panel">
        <div class="canvas-wrap">
          <canvas id="map" width="1000" height="500" aria-label="Carte du monde"></canvas>
        </div>
        <div class="legend">
          <span class="key"><span class="dot homme"></span> Homme</span>
          <span class="key"><span class="dot femme"></span> Femme</span>
          <span class="key">Grille: 30¬∞ lat/lon</span>
        </div>
      </section>
    </div>

    <section class="panel" style="margin-top: 12px;">
      <div id="out" class="out">Le message appara√Ætra ici.</div>
    </section>
  </div>

  <script>
    // Minimal list of countries with emoji flags, approximate centroids
    const COUNTRIES = [
      { code: 'FR', name: 'France', flag: 'üá´üá∑', lat: 46.2276, lon: 2.2137, continent: 'Europe', francophone: true },
      { code: 'MA', name: 'Maroc', flag: 'üá≤üá¶', lat: 31.7917, lon: -7.0926, continent: 'Afrique', francophone: true },
      { code: 'DZ', name: 'Alg√©rie', flag: 'üá©üáø', lat: 28.0339, lon: 1.6596, continent: 'Afrique', francophone: true },
      { code: 'TN', name: 'Tunisie', flag: 'üáπüá≥', lat: 33.8869, lon: 9.5375, continent: 'Afrique', francophone: true },
      { code: 'SN', name: 'S√©n√©gal', flag: 'üá∏üá≥', lat: 14.4974, lon: -14.4524, continent: 'Afrique', francophone: true },
      { code: 'CI', name: "C√¥te d'Ivoire", flag: 'üá®üáÆ', lat: 7.54, lon: -5.5471, continent: 'Afrique', francophone: true },
      { code: 'ES', name: 'Espagne', flag: 'üá™üá∏', lat: 40.4637, lon: -3.7492, continent: 'Europe', francophone: false },
      { code: 'IT', name: 'Italie', flag: 'üáÆüáπ', lat: 41.8719, lon: 12.5674, continent: 'Europe', francophone: false },
      { code: 'DE', name: 'Allemagne', flag: 'üá©üá™', lat: 51.1657, lon: 10.4515, continent: 'Europe', francophone: false },
      { code: 'BE', name: 'Belgique', flag: 'üáßüá™', lat: 50.5039, lon: 4.4699, continent: 'Europe', francophone: true },
      { code: 'CH', name: 'Suisse', flag: 'üá®üá≠', lat: 46.8182, lon: 8.2275, continent: 'Europe', francophone: true },
      { code: 'CA', name: 'Canada', flag: 'üá®üá¶', lat: 56.1304, lon: -106.3468, continent: 'Am√©riques', francophone: true },
      { code: 'US', name: '√âtats-Unis', flag: 'üá∫üá∏', lat: 37.0902, lon: -95.7129, continent: 'Am√©riques', francophone: false },
      { code: 'BR', name: 'Br√©sil', flag: 'üáßüá∑', lat: -14.2350, lon: -51.9253, continent: 'Am√©riques', francophone: false },
      { code: 'AR', name: 'Argentine', flag: 'üá¶üá∑', lat: -38.4161, lon: -63.6167, continent: 'Am√©riques', francophone: false },
      { code: 'GB', name: 'Royaume-Uni', flag: 'üá¨üáß', lat: 55.3781, lon: -3.4360, continent: 'Europe', francophone: false },
      { code: 'PT', name: 'Portugal', flag: 'üáµüáπ', lat: 39.3999, lon: -8.2245, continent: 'Europe', francophone: false },
      { code: 'EG', name: '√âgypte', flag: 'üá™üá¨', lat: 26.8206, lon: 30.8025, continent: 'Afrique', francophone: false },
      { code: 'TR', name: 'Turquie', flag: 'üáπüá∑', lat: 38.9637, lon: 35.2433, continent: 'Asie', francophone: false },
      { code: 'SA', name: 'Arabie saoudite', flag: 'üá∏üá¶', lat: 23.8859, lon: 45.0792, continent: 'Asie', francophone: false },
      { code: 'AE', name: '√âmirats arabes unis', flag: 'üá¶üá™', lat: 23.4241, lon: 53.8478, continent: 'Asie', francophone: false },
      { code: 'JP', name: 'Japon', flag: 'üáØüáµ', lat: 36.2048, lon: 138.2529, continent: 'Asie', francophone: false },
      { code: 'CN', name: 'Chine', flag: 'üá®üá≥', lat: 35.8617, lon: 104.1954, continent: 'Asie', francophone: false },
      { code: 'IN', name: 'Inde', flag: 'üáÆüá≥', lat: 20.5937, lon: 78.9629, continent: 'Asie', francophone: false },
    ];

    const $ = (sel) => document.querySelector(sel);

    const nameH = $('#nameH');
    const nameF = $('#nameF');
    const selectH = $('#countryH');
    const selectF = $('#countryF');
         const checkboxDarija = $('#darija');
     const langSelect = $('#langSelect');
     const avatarInput = $('#avatarInput');
     const avatarPreview = $('#avatarPreview');
     const emojiPicker = $('#emojiPicker');
     const xpFill = $('#xpFill');
     const xpLabel = $('#xpLabel');
     const btnResetXP = $('#btnResetXP');

     const btnUpdate = $('#btnUpdate');
     const btnMsg = $('#btnMsg');
     const btnCopy = $('#btnCopy');
     const scoreLine = $('#scoreLine');
     const out = $('#out');
           const btnDownload = $('#btnDownload');

      // Gemini proxy endpoint and demo key (not persisted)
      const PROXY_GEMINI_URL = '/api/gemini/generate-romance';
      let DEMO_GEMINI_API_KEY = null;

    const canvas = document.getElementById('map');
    const ctx = canvas.getContext('2d');

    // Persistent state
    let xpTotal = 0;
    let selectedEmoji = '';
    let avatarDataUrl = '';

    const EMOJI_OPTIONS = ['üíñ','üíò','üíù','üíû','üíï','üíì','üíó','üíü','ü•∞','üòç','üòò','üòä','‚ú®','üåü','üå∏','üåπ','üéâ','üî•'];

    function saveState() {
      try {
        localStorage.setItem('xpTotal', String(xpTotal));
        localStorage.setItem('selectedEmoji', selectedEmoji || '');
        localStorage.setItem('avatarDataUrl', avatarDataUrl || '');
        if (langSelect) localStorage.setItem('lang', langSelect.value);
      } catch (e) { /* ignore */ }
    }

    function loadState() {
      try {
        xpTotal = parseInt(localStorage.getItem('xpTotal') || '0', 10);
        selectedEmoji = localStorage.getItem('selectedEmoji') || '';
        avatarDataUrl = localStorage.getItem('avatarDataUrl') || '';
        const storedLang = localStorage.getItem('lang');
        if (storedLang && langSelect) langSelect.value = storedLang;
      } catch (e) { /* ignore */ }
      updateXPUI();
      if (avatarDataUrl && avatarPreview) avatarPreview.src = avatarDataUrl;
    }

    function updateXPUI() {
      const level = Math.floor(xpTotal / 100);
      const progress = xpTotal % 100;
      if (xpFill) xpFill.style.width = `${progress}%`;
      if (xpLabel) xpLabel.textContent = `XP: ${xpTotal} (Niv. ${level})`;
      const bar = document.querySelector('.xp-bar');
      if (bar) { bar.setAttribute('aria-valuenow', String(progress)); }
    }

    function addXP(points) {
      xpTotal = Math.max(0, xpTotal + points);
      updateXPUI();
      saveState();
    }

    function resetXP() {
      xpTotal = 0;
      updateXPUI();
      saveState();
    }

    function buildEmojiPicker() {
      if (!emojiPicker) return;
      emojiPicker.innerHTML = '';
      EMOJI_OPTIONS.forEach(em => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'emoji-btn' + (selectedEmoji === em ? ' selected' : '');
        btn.textContent = em;
        btn.setAttribute('role', 'option');
        btn.setAttribute('aria-selected', selectedEmoji === em ? 'true' : 'false');
        btn.addEventListener('click', () => {
          selectedEmoji = em;
          [...emojiPicker.querySelectorAll('.emoji-btn')].forEach(b => { b.classList.remove('selected'); b.setAttribute('aria-selected', 'false'); });
          btn.classList.add('selected');
          btn.setAttribute('aria-selected', 'true');
          saveState();
          drawAll();
        });
        emojiPicker.appendChild(btn);
      });
    }

    function handleAvatarInput(e) {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        avatarDataUrl = String(reader.result || '');
        if (avatarPreview) avatarPreview.src = avatarDataUrl;
        saveState();
      };
      reader.readAsDataURL(file);
    }

    function composeMessages(params) {
      const { h, f, distanceKm, score, nameA, nameB } = params;
      const hearts = ['üíû', 'üíñ', 'üíó', 'üíò', 'üíù'];
      const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];
      const extra = selectedEmoji ? ` ${selectedEmoji}` : '';

      const fr = [
        `${nameA}${extra} (${h.flag} ${h.name}) et ${nameB}${extra} (${f.flag} ${f.name}) sont s√©par√©s par ${formatKm(distanceKm)}, mais leurs c≈ìurs n‚Äôont pas de fronti√®res. Compatibilit√©: ${score}/100 ${pick(hearts)}`,
        `Entre ${nameA}${extra} et ${nameB}${extra}, les destins se chuchotent doucement. ${h.flag}+${f.flag} ‚Üí ${score}/100 ${pick(hearts)}`,
        `${nameA}${extra} rencontre ${nameB}${extra} √† mi-chemin du monde. Distance: ${formatKm(distanceKm)} ¬∑ Score: ${score}/100 ${pick(hearts)}`,
      ];

      const dj_lat = [
        `${nameA}${extra} w ${nameB}${extra} b3id bainathom ${formatKm(distanceKm)}, walakin l9loub ma 3and-homch hdoud. N9ta: ${score}/100 ${pick(hearts)}`,
        `${nameA}${extra} w ${nameB}${extra} ktla9aw f nos d-dnya. L-b3d ghyr r9m, w l-hob kayrba7. N9ta: ${score}/100 ${pick(hearts)}`,
        `Ben ${h.flag} w ${f.flag}, ${nameA}${extra} w ${nameB}${extra} kayqtarbo b l-hob. ${score}/100 ${pick(hearts)}`,
      ];

      const dj_ar = [
        `${nameA}${extra} Ÿà ${nameB}${extra} ÿ®ÿπŸäÿØ ÿ®ŸäŸÜÿßÿ™ŸáŸÖ ${formatKm(distanceKm)}ÿå ŸàŸÑŸÉŸÜ ÿßŸÑŸÇŸÑŸàÿ® ŸÖÿß ÿπŸÜÿØŸáÿßÿ¥ ÿ≠ÿØŸàÿØ. ÿßŸÑŸÜŸÇÿ∑ÿ©: ${score}/100 ${pick(hearts)}`,
        `${nameA}${extra} Ÿà ${nameB}${extra} ÿ™ŸäŸÑŸÇÿßŸà ŸÅ ŸÜŸèÿµŸë ÿßŸÑÿØŸÜŸäÿß. ÿßŸÑÿ®ÿπÿØ ÿ∫Ÿäÿ± ÿ±ŸÇŸÖÿå ŸàÿßŸÑÿ≠ÿ® ŸÉŸäÿ±ÿ®ÿ≠. ÿßŸÑŸÜŸÇÿ∑ÿ©: ${score}/100 ${pick(hearts)}`,
        `ÿ®ŸäŸÜ ${h.flag} Ÿà ${f.flag}, ${nameA}${extra} Ÿà ${nameB}${extra} ŸÉŸäŸÇÿ±ÿ®Ÿà ÿ®ÿßŸÑŸÇŸÑÿ®. ${score}/100 ${pick(hearts)}`,
      ];

      return { fr: pick(fr), darija_lat: pick(dj_lat), darija_ar: pick(dj_ar) };
    }

    function populateSelects() {
      const options = COUNTRIES.map(c => `<option value="${c.code}">${c.flag} ${c.name}</option>`).join('');
      selectH.innerHTML = options;
      selectF.innerHTML = options;
      // Defaults
      selectH.value = 'FR';
      selectF.value = 'MA';
    }

    function getCountry(code) { return COUNTRIES.find(c => c.code === code); }

    function resizeCanvasToContainer() {
      const parent = canvas.parentElement;
      const cssWidth = parent.clientWidth;
      const cssHeight = cssWidth / 2; // 2:1 aspect
      const dpr = Math.min(window.devicePixelRatio || 1, 2);
      canvas.style.width = cssWidth + 'px';
      canvas.style.height = cssHeight + 'px';
      canvas.width = Math.floor(cssWidth * dpr);
      canvas.height = Math.floor(cssHeight * dpr);
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }

    function lonLatToXY(lon, lat) {
      // Equirectangular projection
      const w = canvas.clientWidth;
      const h = canvas.clientHeight;
      const x = (lon + 180) / 360 * w;
      const y = (90 - lat) / 180 * h;
      return { x, y };
    }

    function drawBackground() {
      const w = canvas.clientWidth;
      const h = canvas.clientHeight;
      // Ocean background
      const grad = ctx.createLinearGradient(0, 0, 0, h);
      grad.addColorStop(0, '#0a1a2f');
      grad.addColorStop(1, '#071426');
      ctx.fillStyle = grad;
      ctx.fillRect(0, 0, w, h);

      // Subtle stars
      ctx.save();
      ctx.globalAlpha = 0.25;
      ctx.fillStyle = '#94a3b8';
      for (let i = 0; i < 80; i++) {
        const x = Math.random() * w;
        const y = Math.random() * h;
        const r = Math.random() * 0.8 + 0.2;
        ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI * 2); ctx.fill();
      }
      ctx.restore();

      // Graticule every 30¬∞
      ctx.save();
      ctx.strokeStyle = 'rgba(148,163,184,0.22)';
      ctx.lineWidth = 1;
      for (let lon = -180; lon <= 180; lon += 30) {
        const { x } = lonLatToXY(lon, 0);
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, h);
        ctx.stroke();
      }
      for (let lat = -90; lat <= 90; lat += 30) {
        const { y } = lonLatToXY(0, lat);
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(w, y);
        ctx.stroke();
      }
      // Equator & Greenwich
      ctx.strokeStyle = 'rgba(56,189,248,0.45)';
      ctx.lineWidth = 1.5;
      let p = lonLatToXY(0, 0); ctx.beginPath(); ctx.moveTo(0, p.y); ctx.lineTo(w, p.y); ctx.stroke();
      p = lonLatToXY(0, 0); ctx.beginPath(); ctx.moveTo(p.x, 0); ctx.lineTo(p.x, h); ctx.stroke();
      ctx.restore();

      // Soft vignette
      const g2 = ctx.createRadialGradient(w * 0.5, h * 0.5, Math.min(w, h) * 0.2, w * 0.5, h * 0.5, Math.max(w, h) * 0.7);
      g2.addColorStop(0, 'rgba(0,0,0,0)');
      g2.addColorStop(1, 'rgba(0,0,0,0.33)');
      ctx.fillStyle = g2;
      ctx.fillRect(0, 0, w, h);
    }

    function drawAvatar(point, type, label, flag) {
      const isHomme = type === 'homme';
      const color = isHomme ? '#38bdf8' : '#f472b6';
      const bg = isHomme ? 'rgba(56,189,248,0.15)' : 'rgba(244,114,182,0.15)';
      const emoji = isHomme ? 'üë®' : 'üë©';
      const r = 18;

      // Glow
      ctx.save();
      ctx.fillStyle = bg;
      ctx.beginPath(); ctx.arc(point.x, point.y, r + 10, 0, Math.PI * 2); ctx.fill();
      ctx.restore();

      // Dot
      ctx.beginPath();
      ctx.fillStyle = color;
      ctx.arc(point.x, point.y, 6, 0, Math.PI * 2);
      ctx.fill();

      // Emoji label
      ctx.font = '20px system-ui, Apple Color Emoji, Segoe UI Emoji';
      ctx.textAlign = 'left';
      ctx.textBaseline = 'middle';
      ctx.fillStyle = '#e5e7eb';
      ctx.fillText(`${emoji} ${label} ${flag}`, point.x + 10, point.y);
    }

    function drawArc(a, b) {
      // Curved connection
      const midX = (a.x + b.x) / 2;
      const midY = (a.y + b.y) / 2;
      const dx = b.x - a.x;
      const dy = b.y - a.y;
      const dist = Math.hypot(dx, dy);
      const nx = -dy / (dist || 1);
      const ny = dx / (dist || 1);
      const bulge = Math.min(140, 20 + dist * 0.15);
      const cx = midX + nx * bulge;
      const cy = midY + ny * bulge;

      const grad = ctx.createLinearGradient(a.x, a.y, b.x, b.y);
      grad.addColorStop(0, 'rgba(56,189,248,0.9)');
      grad.addColorStop(1, 'rgba(244,114,182,0.9)');

      ctx.save();
      ctx.lineWidth = 3;
      ctx.strokeStyle = grad;
      ctx.beginPath();
      ctx.moveTo(a.x, a.y);
      ctx.quadraticCurveTo(cx, cy, b.x, b.y);
      ctx.stroke();

      // Hearts along the path
      ctx.font = '18px system-ui, Apple Color Emoji, Segoe UI Emoji';
      ctx.fillStyle = '#fda4af';
      for (let t of [0.25, 0.5, 0.75]) {
        const x = (1 - t) * (1 - t) * a.x + 2 * (1 - t) * t * cx + t * t * b.x;
        const y = (1 - t) * (1 - t) * a.y + 2 * (1 - t) * t * cy + t * t * b.y;
        ctx.fillText('‚ù§', x - 8, y - 8);
      }
      ctx.restore();
    }

    // Haversine distance in km
    function haversineKm(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const toRad = (d) => d * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function clamp(v, min, max) { return Math.max(min, Math.min(max, v)); }

    function seededNoise(str) {
      // Simple deterministic pseudo-random based on string
      let h = 2166136261 >>> 0;
      for (let i = 0; i < str.length; i++) {
        h ^= str.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      // Map to [-1, 1]
      return (h % 2000) / 1000 - 1;
    }

    function computeCompatibility(a, b, namesKey) {
      const distanceKm = haversineKm(a.lat, a.lon, b.lat, b.lon);
      let base = 100 - (distanceKm / 200); // -1 per 200 km
      let bonus = 0;
      if (a.francophone && b.francophone) bonus += 10;
      if (a.continent === b.continent) bonus += 5;
      bonus += seededNoise(namesKey) * 5; // ¬±5 stable by names
      const score = Math.round(clamp(base + bonus, 5, 99));
      return { distanceKm, score, bonus: Math.round(bonus) };
    }

    function formatKm(km) {
      return km < 1000 ? `${Math.round(km)} km` : `${(km/1000).toFixed(1)}k km`;
    }

    function drawAll() {
      resizeCanvasToContainer();
      drawBackground();

      const h = getCountry(selectH.value);
      const f = getCountry(selectF.value);
      const pH = lonLatToXY(h.lon, h.lat);
      const pF = lonLatToXY(f.lon, f.lat);

      drawArc(pH, pF);
      const labelH = (nameH.value || 'Homme') + (selectedEmoji ? ` ${selectedEmoji}` : '');
      const labelF = (nameF.value || 'Femme') + (selectedEmoji ? ` ${selectedEmoji}` : '');
      drawAvatar(pH, 'homme', labelH, h.flag);
      drawAvatar(pF, 'femme', labelF, f.flag);

      const { distanceKm, score, bonus } = computeCompatibility(h, f, `${nameH.value}|${nameF.value}`);
      scoreLine.innerHTML = `Distance: <strong>${formatKm(distanceKm)}</strong> ¬∑ Compatibilit√©: <strong>${score}/100</strong> ${bonus !== 0 ? `(bonus ${bonus >= 0 ? '+' : ''}${bonus})` : ''}`;
    }

    // --- Export helpers ---
    function wrapTextToLines(context, text, maxWidth) {
      const words = text.split(/\s+/);
      const lines = [];
      let current = '';
      for (let i = 0; i < words.length; i++) {
        const test = current ? current + ' ' + words[i] : words[i];
        if (context.measureText(test).width <= maxWidth) {
          current = test;
        } else {
          if (current) lines.push(current);
          current = words[i];
        }
      }
      if (current) lines.push(current);
      return lines;
    }

    function drawRoundedRect(context, x, y, w, h, r) {
      context.beginPath();
      context.moveTo(x + r, y);
      context.lineTo(x + w - r, y);
      context.quadraticCurveTo(x + w, y, x + w, y + r);
      context.lineTo(x + w, y + h - r);
      context.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
      context.lineTo(x + r, y + h);
      context.quadraticCurveTo(x, y + h, x, y + h - r);
      context.lineTo(x, y + r);
      context.quadraticCurveTo(x, y, x + r, y);
      context.closePath();
    }

    function loadImage(src) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = src;
      });
    }

    async function composeExportImage() {
      // Dimensions of the export image
      const width = 1400;
      const height = 900;
      const margin = 28;
      const rightPanelWidth = 460;
      const gap = 20;

      const off = document.createElement('canvas');
      off.width = width;
      off.height = height;
      const c = off.getContext('2d');

      // Background
      const bg = c.createLinearGradient(0, 0, 0, height);
      bg.addColorStop(0, '#0b1220');
      bg.addColorStop(1, '#0a0f1e');
      c.fillStyle = bg;
      c.fillRect(0, 0, width, height);

      // Title
      c.fillStyle = '#e5e7eb';
      c.font = '700 28px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto';
      c.fillText('Amour √† travers le monde ‚Äî Export', margin, margin + 8);

      // Subtle border panel
      drawRoundedRect(c, margin, margin + 24, width - margin * 2, height - margin * 2 - 24, 14);
      c.strokeStyle = 'rgba(148,163,184,0.18)';
      c.lineWidth = 2;
      c.stroke();

      const h = getCountry(selectH.value);
      const f = getCountry(selectF.value);
      const { distanceKm, score } = computeCompatibility(h, f, `${nameH.value}|${nameF.value}`);

      // Map snapshot on the left
      const leftWidth = width - margin * 2 - rightPanelWidth - gap;
      const mapSrcCanvas = canvas; // already painted map
      const mapAspect = mapSrcCanvas.width / mapSrcCanvas.height;
      const targetH = Math.min(height - margin * 2 - 80, Math.round(leftWidth / mapAspect));
      const mapX = margin + 10;
      const mapY = margin + 50;
      drawRoundedRect(c, mapX - 10, mapY - 10, leftWidth + 20, targetH + 20, 12);
      c.fillStyle = '#0b1220';
      c.fill();
      c.drawImage(mapSrcCanvas, mapX, mapY, leftWidth, targetH);

      // Legend under the map
      c.font = '12px ui-sans-serif, system-ui';
      c.fillStyle = '#94a3b8';
      const legendY = mapY + targetH + 18;
      c.beginPath(); c.fillStyle = '#38bdf8'; c.arc(mapX + 6, legendY - 3, 5, 0, Math.PI*2); c.fill();
      c.fillStyle = '#94a3b8'; c.fillText('Homme', mapX + 18, legendY);
      c.beginPath(); c.fillStyle = '#f472b6'; c.arc(mapX + 80 + 6, legendY - 3, 5, 0, Math.PI*2); c.fill();
      c.fillStyle = '#94a3b8'; c.fillText('Femme', mapX + 80 + 18, legendY);
      c.fillText('Grille: 30¬∞ lat/lon', mapX + 160, legendY);

      // Right info panel
      const panelX = margin + leftWidth + gap;
      const panelY = margin + 50;
      const panelW = rightPanelWidth;
      const panelH = height - panelY - margin;
      drawRoundedRect(c, panelX, panelY, panelW, panelH, 12);
      c.fillStyle = '#0b1220';
      c.fill();
      c.strokeStyle = 'rgba(148,163,184,0.18)';
      c.stroke();

      // Names + flags
      c.fillStyle = '#e5e7eb';
      c.font = '600 20px ui-sans-serif, system-ui';
      const line1 = `${h.flag} ${nameH.value || 'Adam'}` + (selectedEmoji ? ` ${selectedEmoji}` : '');
      const line2 = `${f.flag} ${nameF.value || 'Eva'}` + (selectedEmoji ? ` ${selectedEmoji}` : '');
      c.fillText(line1, panelX + 16, panelY + 34);
      c.fillText(line2, panelX + 16, panelY + 62);

      // Stats pills
      c.font = '14px ui-sans-serif, system-ui';
      const pillY = panelY + 92;
      function drawPill(text, x) {
        const padX = 10, padY = 6, rad = 999;
        const w = Math.ceil(c.measureText(text).width) + padX * 2;
        drawRoundedRect(c, x, pillY - 16, w, 28, 14);
        c.fillStyle = '#0b1220'; c.fill();
        c.strokeStyle = 'rgba(148,163,184,0.18)'; c.stroke();
        c.fillStyle = '#94a3b8'; c.fillText(text, x + padX, pillY);
        return w + 8;
      }
      let nextX = panelX + 16;
      nextX += drawPill(`Distance: ${formatKm(distanceKm)}`, nextX);
      nextX += drawPill(`Score: ${score}/100`, nextX);

      // Avatar circle if available
      if (avatarDataUrl) {
        try {
          const img = await loadImage(avatarDataUrl);
          const size = 96;
          const ax = panelX + 16;
          const ay = pillY + 24;
          c.save();
          c.beginPath();
          c.arc(ax + size/2, ay + size/2, size/2, 0, Math.PI*2);
          c.closePath();
          c.clip();
          c.drawImage(img, ax, ay, size, size);
          c.restore();
          // avatar border
          c.strokeStyle = 'rgba(148,163,184,0.35)';
          c.lineWidth = 2;
          c.beginPath();
          c.arc(ax + size/2, ay + size/2, size/2, 0, Math.PI*2);
          c.stroke();
        } catch (e) { /* ignore */ }
      }

      // Message block
      const msgTitleY = panelY + 240;
      c.fillStyle = '#e5e7eb';
      c.font = '600 16px ui-sans-serif, system-ui';
      c.fillText('Message', panelX + 16, msgTitleY);
      const msgBoxX = panelX + 12;
      const msgBoxY = msgTitleY + 10;
      const msgBoxW = panelW - 24;
      const msgBoxH = panelH - (msgBoxY - panelY) - 16;
      drawRoundedRect(c, msgBoxX, msgBoxY, msgBoxW, msgBoxH, 10);
      c.fillStyle = '#0a1020'; c.fill();
      c.strokeStyle = 'rgba(148,163,184,0.15)'; c.stroke();

      // Get message text (fallback generate if empty)
      let messageText = (out && out.innerText ? out.innerText.trim() : '').trim();
      if (!messageText) {
        // Try generate one quickly
        try { generateMessage(); messageText = (out && out.innerText ? out.innerText.trim() : '').trim(); } catch (e) {}
      }

      c.save();
      c.beginPath();
      c.rect(msgBoxX + 12, msgBoxY + 12, msgBoxW - 24, msgBoxH - 24);
      c.clip();
      c.fillStyle = '#e5e7eb';
      c.font = '14px ui-sans-serif, system-ui, "Apple Color Emoji", "Segoe UI Emoji"';
      const maxW = msgBoxW - 24;
      const lines = [];
      const paragraphs = (messageText || 'Le message appara√Ætra ici.').split(/\n+/);
      paragraphs.forEach(p => {
        const wrapped = wrapTextToLines(c, p, maxW);
        if (wrapped.length === 0) { lines.push(''); }
        else { wrapped.forEach(w => lines.push(w)); }
        lines.push('');
      });
      let ty = msgBoxY + 28;
      const lh = 22;
      for (let ln of lines) {
        if (ty > msgBoxY + msgBoxH - 10) break;
        c.fillText(ln, msgBoxX + 18, ty);
        ty += lh;
      }
      c.restore();

      // Footer timestamp
      const now = new Date();
      const pad = (n) => String(n).padStart(2, '0');
      const stamp = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}`;
      c.fillStyle = '#94a3b8';
      c.font = '12px ui-sans-serif, system-ui';
      c.fillText(`G√©n√©r√© le ${stamp}`, margin, height - 10);

      return off.toDataURL('image/png');
    }

    async function downloadImage() {
      try {
        const dataUrl = await composeExportImage();
        const a = document.createElement('a');
        const h = getCountry(selectH.value);
        const f = getCountry(selectF.value);
        const nameA = (nameH.value || 'Adam').replace(/\s+/g, '_');
        const nameB = (nameF.value || 'Eva').replace(/\s+/g, '_');
        const now = new Date();
        const pad = (n) => String(n).padStart(2, '0');
        const fname = `amour_${nameA}_${nameB}_${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}.png`;
        a.href = dataUrl;
        a.download = fname;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      } catch (e) {
        alert('√âchec de la g√©n√©ration de l\'image.');
      }
    }

    function pick(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

    async function generateViaProxy({ h, f, distanceKm, score, nameA, nameB }) {
      const body = {
        h: { code: h.code, name: h.name, flag: h.flag },
        f: { code: f.code, name: f.name, flag: f.flag },
        distanceKm,
        score,
        nameA,
        nameB,
        lang: (langSelect && langSelect.value) || 'fr'
      };
      const res = await fetch(PROXY_GEMINI_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      if (!res.ok) throw new Error('proxy_failed');
      const data = await res.json();
      if (!data || !data.messages) throw new Error('bad_proxy_payload');
      return data.messages;
    }

    async function generateViaGeminiDirect({ h, f, distanceKm, score, nameA, nameB }) {
      if (!DEMO_GEMINI_API_KEY) {
        const maybe = prompt('Mode d√©mo: colle une cl√© API Gemini temporaire. Elle ne sera PAS sauvegard√©e.');
        if (!maybe) throw new Error('no_demo_key');
        DEMO_GEMINI_API_KEY = maybe.trim();
      }
      const sys = 'Tu es un assistant qui √©crit des messages romantiques courts, mignons et vari√©s. Garde un ton chaleureux, pas trop long.';
      const promptFr = `Cr√©e un court message romantique en fran√ßais pour ${nameA} (${h.flag} ${h.name}) et ${nameB} (${f.flag} ${f.name}). Distance: ${Math.round(distanceKm)} km. Score: ${score}/100.`;
      const promptDjLat = `En darija (latin), une variante courte et mignonne pour ${nameA} (${h.flag}) et ${nameB} (${f.flag}).`;
      const promptDjAr = `ÿ®ÿßŸÑÿØÿßÿ±ÿ¨ÿ© ÿßŸÑŸÖÿ∫ÿ±ÿ®Ÿäÿ© (ÿßŸÑÿπÿ±ÿ®Ÿäÿ©)ÿå ÿ±ÿ≥ÿßŸÑÿ© ŸÇÿµŸäÿ±ÿ© Ÿàÿ¨ŸÖŸäŸÑÿ© ŸÑŸÄ ${nameA} (${h.flag}) Ÿà ${nameB} (${f.flag}).`;

      const contents = [
        { role: 'user', parts: [{ text: sys + '\n' + promptFr }] },
        { role: 'user', parts: [{ text: promptDjLat }] },
        { role: 'user', parts: [{ text: promptDjAr }] }
      ];

      const res = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=' + encodeURIComponent(DEMO_GEMINI_API_KEY), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents })
      });
      if (!res.ok) throw new Error('gemini_direct_failed');
      const data = await res.json();
      const text = (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0] && data.candidates[0].content.parts[0].text) || '';

      // Try to split 3 lines; otherwise reuse local composer for structure
      const lines = text.split(/\n+/).filter(Boolean);
      const fallback = composeMessages({ h, f, distanceKm, score, nameA, nameB });
      return {
        fr: lines[0] || fallback.fr,
        darija_lat: lines[1] || fallback.darija_lat,
        darija_ar: lines[2] || fallback.darija_ar
      };
    }

    async function generateMessage() {
      const h = getCountry(selectH.value);
      const f = getCountry(selectF.value);
      const { distanceKm, score } = computeCompatibility(h, f, `${nameH.value}|${nameF.value}`);

      const nameA = nameH.value || 'Adam';
      const nameB = nameF.value || 'Eva';

      // Try server proxy (no API key on client)
      let messages = null;
      try {
        messages = await generateViaProxy({ h, f, distanceKm, score, nameA, nameB });
      } catch (_) {}

      // If proxy unavailable, try demo mode (prompt for temporary key, not saved)
      if (!messages) {
        try {
          messages = await generateViaGeminiDirect({ h, f, distanceKm, score, nameA, nameB });
        } catch (_) {}
      }

      // Fallback to local templates if all else fails
      if (!messages) {
        messages = composeMessages({ h, f, distanceKm, score, nameA, nameB });
      }

      const choice = (langSelect && langSelect.value) ? langSelect.value : 'fr';
      let html = '';
      if (choice === 'fr') {
        html = messages.fr;
      } else if (choice === 'darija_lat') {
        html = `‚Äî Darija ‚Äî<br>${messages.darija_lat}`;
      } else if (choice === 'darija_ar') {
        html = `‚Äî ÿßŸÑÿØÿßÿ±ÿ¨ÿ© ‚Äî<br><span dir="rtl">${messages.darija_ar}</span>`;
      } else if (choice === 'all') {
        html = `${messages.fr}
<br><br>‚Äî Darija ‚Äî<br>${messages.darija_lat}
<br><br>‚Äî ÿßŸÑÿØÿßÿ±ÿ¨ÿ© ‚Äî<br><span dir="rtl">${messages.darija_ar}</span>`;
      }
      // Legacy toggle: append darija (latin) if checked and not already showing all
      if (checkboxDarija && checkboxDarija.checked && choice !== 'all' && choice !== 'darija_lat') {
        html += `
<br><br>‚Äî Darija ‚Äî<br>${messages.darija_lat}`;
      }

      out.innerHTML = html;

      // XP gain: +5 per generation, +5 bonus if score > 85
      let gain = 5;
      if (score > 85) gain += 5;
      addXP(gain);
    }

    function copyMessage() {
      const text = out.textContent.trim();
      if (!text) return;
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => {
          out.textContent = text + "\n\n(Copi√© dans le presse-papiers ‚úÖ)";
        }).catch(() => fallbackCopy(text));
      } else { fallbackCopy(text); }

      function fallbackCopy(t) {
        const ta = document.createElement('textarea');
        ta.value = t; document.body.appendChild(ta); ta.select();
        try { document.execCommand('copy'); } catch (e) {}
        document.body.removeChild(ta);
      }
    }

    // Init
    populateSelects();
    loadState();
    buildEmojiPicker();
    if (avatarInput) avatarInput.addEventListener('change', handleAvatarInput);
    if (btnResetXP) btnResetXP.addEventListener('click', resetXP);
    if (langSelect) langSelect.addEventListener('change', () => { saveState(); generateMessage(); });
    window.addEventListener('resize', drawAll);
    btnUpdate.addEventListener('click', drawAll);
    [selectH, selectF, nameH, nameF].forEach(el => el.addEventListener('change', drawAll));
    btnMsg.addEventListener('click', generateMessage);
    btnCopy.addEventListener('click', copyMessage);
    if (btnDownload) btnDownload.addEventListener('click', downloadImage);

    // First paint
    drawAll();
  </script>
</body>
</html>